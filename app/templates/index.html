<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storyl</title>
    <link href="{{ url_for('static', filename='css/tailwind.css') }}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-image: url("{{ url_for('static', filename='images/papyrus.png') }}");
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .loader {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid brown; /* Blue */
            border-radius: 50%;
            width: 45px;
            height: 45px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="{{url_for('static', filename='js/utils.js') }}"></script>
</head>
<body class="flex flex-col h-screen bg-gray-100">

<div class="h-full w-full flex">

    <!-- Sidebar -->
    <div class="w-64 bg-gray-800 text-white p-6 flex flex-col gap-8 pt-20">
        <div>
            <h1 class="text-xl font-bold mb-4">Joueurs</h1>
            <div id="players-list-container" class="h-64 py-8 overflow-y-auto joueurs-list">
                <ul class="space-y-4">
                {% if players and players|length > 0 %}
                    {% for player in players %}
                    <li>
                        <a href="#" data-index="{{ loop.index0 }}"
                           class="block py-2 px-4 bg-gray-700 rounded-md hover:bg-gray-600">{{ player.id }}</a>
                    </li>
                    {% endfor %}
                {% else %}
                <p class="text-gray-500 text-center">Aucun joueur</p>
                {% endif %}
                </ul>
            </div>
        </div>

        <div>
            <h1 class="text-xl font-bold mb-4">Lieux</h1>
            <div id="locations-list-container" class="h-64 py-8 overflow-y-auto locations-list">
                <ul class="space-y-4">
                {% if locations and locations|length > 0 %}
                    {% for location in locations %}
                    <li>
                        <a href="#" data-index="{{ loop.index0 }}" class="block py-2 px-4 bg-gray-700 rounded-md hover:bg-gray-600">{{ location.id
                            }}</a>
                    </li>
                    {% endfor %}
                {% else %}
                <p class="text-gray-500 text-center">Aucun Lieu</p>
                {% endif %}
                </ul>
            </div>
        </div>

        <!-- Quest Summary Card Section -->
        <div class="hidden">
            <h1 class="text-xl font-bold mb-4 ">Quête en cours</h1>
            <a href="#">
                <div class="bg-gray-700 p-4 rounded-lg shadow-lg hover:bg-gray-600 hover:shadow-xl transition duration-300 ease-in-out">
                    <h2 class="text-lg font-semibold mb-2">Résumé de la quête</h2>
                    <p class="text-sm text-gray-300 mb-4">
                        {% if current_quest %}
                        {{ current_quest.summary }}
                        {% else %}
                        Aucune quête en cours.
                        {% endif %}
                    </p>
                </div>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <nav class="bg-gray-800 p-4 flex items-center justify-between shadow-lg">
            <!-- App Name -->
            <div class="text-white text-2xl font-bold mx-auto">
                STORYL
            </div>
            <!-- Settings Icon -->
            <div id="setting" class="text-white text-2xl cursor-pointer hover:text-gray-400 relative">
                <i class="fa fa-bars" aria-hidden="true"></i>
                <div id="dropdown-menu" class="hidden absolute right-0 mt-2 bg-white rounded-md shadow-lg z-20">
                    <ul class="py-1 text-sm w-[100px]">
                        <li><a href="#" class="block px-4 py-2 text-gray-800 hover:bg-gray-100" onclick="confirmReset()">Reset</a></li>
                        <li><a href="#" class="block px-4 py-2 text-gray-800 hover:bg-gray-100" onclick="changeApiKey()">Change API key</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <script>
            document.getElementById('setting').addEventListener('click', function() {
                const dropdownMenu = document.getElementById('dropdown-menu');
                dropdownMenu.classList.toggle('hidden');
            });

            const confirmReset = async () => {
                if (confirm('Êtes-vous sûr de vouloir réinitialiser le jeu?')) {
                    // Send POST request to the backend
                    const response = await fetch("/reset", {
                        method: 'POST',
                        body: {},
                    });

                    await fetchGameData()
                }
            }

            function changeApiKey() {
                const newApiKey = prompt("Please enter the new API key:");
                if (newApiKey) {
                    fetch('/change-api-key', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({apiKey: newApiKey})
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert("API key changed successfully.");
                            } else {
                                alert("Failed to change API key.");
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert("An error occurred while changing the API key.");
                        });
                }
            }
        </script>

        <!-- Chat Panel -->
        <div id="chat" class="flex-1 flex flex-col relative">

            <!-- Location Tooltip -->
            <div id="location-tooltip-card"
                 class="hidden absolute top-0 left-0 bg-gray-700 text-white p-4 rounded-lg shadow-lg z-20 w-72">
                <h3 class="text-xl font-bold" id="location-name"></h3>
                <p id="location-description" class="mt-2"></p>
            </div>

            <div id="map-card"
                 class="map-card absolute top-0 right-0 m-4 w-32 h-32 bg-gray-700 p-4 rounded-lg shadow-lg z-10 transition-all duration-300 ease-in-out">
                <!-- Card Content, such as map or other info -->
                    <svg id="map-svg" width="100%" height="100%" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid meet"></svg>
            </div>

            <div class="flex justify-center space-x-4 text-lg font-semibold pt-4">
                <span id="current-hour" class="text-gray-600">--</span>
                <span id="time-of-day" class="text-gray-500 italic">--</span>
            </div>


            <div class="flex-1 overflow-auto p-4">
                <div id="chat-window" class="space-y-4 overflow-y-auto max-h-[75vh]">
                    {% for message in logs %}
                    <div class="
                        flex
                        {{ 'justify-start' if message.user == 'MASTER' else '' }}
                        {{ 'justify-center' if message.user in ['SYSTEM', 'FIGHT-DESCRIPTION'] else '' }}
                        {{ 'justify-end' if message.user not in ['MASTER', 'SYSTEM'] else '' }}"
                    >
                        <div class="
                        message
                            bg-gray-200 text-gray-800
                            {{ 'bg-transparent text-gray-800' if message.user == 'SYSTEM' else 'p-4 rounded-lg lg shadow-lg' }}
                            {{ 'italic text-xl' if message.user == 'SYSTEM' else '' }}">

                            {% if not message.user == 'SYSTEM' %}
                                {% if message.user == 'MASTER' %}
                                <p class="font-bold text-sm text-red-700 mb-2">{{ "GAME MASTER" }}</p>

                                {% else %}
                                <p class="font-bold text-sm text-gray-700 mb-2">{{ message.user }}</p>

                                {% endif %}
                            {% endif %}

                            <p>{{ message.message }}</p>
                        </div>
                    </div>

                    {% endfor %}


                </div>

                <div class="loader hidden" id="loader"></div>

            </div>
            <div class="p-4 bg-white rounded-sm">
                <form id="chat-form" class="flex items-center space-x-4" data-action="/submit">
                    <!-- Input Bar with Dropdowns -->
                    <div class="flex items-center w-full border rounded-md overflow-hidden focus-within:ring focus-within:ring-blue-300">
                        <!-- Command Dropdown -->
                        <select id="command-dropdown" name="command"
                                class="bg-gray-100 p-2 border-r text-gray-700 focus:outline-none">
                            <option value="" disabled selected>Choisir une commande</option>
                            {% for command in commands %}
                            <option value="{{ command.command }}">{{ command.command }}</option>
                            {% endfor %}
                        </select>

                        <!-- Player Dropdown -->
                        <select id="player-dropdown" name="player"
                                class="bg-gray-100 p-2 border-r text-gray-700 focus:outline-none hidden">
                            <!-- Player options will be dynamically populated -->
                        </select>

                        <select id="location-dropdown" name="location"
                                class="bg-gray-100 p-2 border-r text-gray-700 focus:outline-none hidden">
                            <!-- Player options will be dynamically populated -->
                        </select>

                        <!-- Coordinate Fields -->
                        <div id="coordinate-fields" class="inline-flex items-center hidden">
                            <input type="number" id="coord-x" name="coord-x"
                                   class="p-2 border rounded-md w-20 focus:outline-none"
                                   placeholder="X"/>
                            <input type="number" id="coord-y" name="coord-y"
                                   class="p-2 border rounded-md w-20 focus:outline-none"
                                   placeholder="Y"
                            />
                        </div>

                        <input type="number" id="time-input" name="time"
                                   class="p-2 border rounded-md w-20 focus:outline-none hidden"
                                   placeholder="Time" min="1"/>

                        <!-- Input Field -->
                        <input type="text" id="user-input" name="prompt"
                               class="flex-1 p-2 text-start focus:outline-none"
                               placeholder="Entrer votre instruction..." required/>
                    </div>


                    <!-- Send Button -->
                    <button id="submit" type="submit"
                            class="px-4 py-2 bg-gray-800 -blue-500 text-white rounded-md hover:bg-gray-700 focus:outline-none">
                        Valider
                    </button>
                </form>

            </div>

        </div>
    </div>
</div>

<script>
    /**
     * Utils Function used across the application.
     */

    /**
     * Pass data from Flask to JavaScript.
     */
    function updateDisplay() {
        document.getElementById('current-hour').textContent = `${state.CURRENT_HOUR}:00`;
        document.getElementById('time-of-day').textContent = state.TIME_OF_DAY;

        // Update element on the UI
        const playerList = document.querySelector('.joueurs-list ul');
        playerList.innerHTML = '';
        if (players.length > 0) {
            players.forEach((player, index) => {
                const playerItem = document.createElement('li');
                playerItem.innerHTML = `
            <a href="#" data-index="${index}" class="block py-2 px-4 bg-gray-700 rounded-md hover:bg-gray-600">${player.id}</a>
        `;
                playerList.appendChild(playerItem);
            });
        } else {
            playerList.innerHTML = '<p class="text-gray-500 text-center">Aucun joueur</p>';
        }

        const locationList = document.querySelector('.locations-list ul');
        locationList.innerHTML = '';
        if (locations.length > 0) {
            locations.forEach((location, index) => {
                const locationItem = document.createElement('li');
                locationItem.innerHTML = `
            <a href="#" data-index="${index}" class="block py-2 px-4 bg-gray-700 rounded-md hover:bg-gray-600">${location.id}</a>
        `;
                locationList.appendChild(locationItem);
            });
        } else {
            locationList.innerHTML = '<p class="text-gray-500 text-center">Aucun Lieu</p>';
        }


        playersItemEventListener();
        locationItemEventListener();
        updateChatLogs();
        updateMap();
    }

    /**
     * Fetch game data from the backend.
     */
    async function fetchGameData(){
        const gameInfo = await fetch('/fetch');
            const gameData = await gameInfo.json();
            players = gameData.players;
            locations = gameData.locations;
            locationsWithMonster = locations.filter(location => location.monstres);
            pnjs = gameData.pnjs;
            logs = gameData.logs;
            state = gameData.state;

            updateDisplay();
    }

    /**
     * Update Map rendering.
     */
    const updateMap = () => {
        mapGroup.selectAll(".location-dot").remove();
        // Create map markers for locations
        mapGroup.selectAll(".location-dot")
            .data(locations)
            .enter()
            .append("circle")
            .attr("cx", d => xScale(d.position.x))
            .attr("cy", d => yScale(d.position.y))
            .attr("r", 6) // Initial radius size
            .attr("fill", "red")
            .attr("stroke", "white")  // Adding a white stroke to make it pop
            .attr("stroke-width", 1)
            .attr("class", "location-dot") // Assign a unique class
            .style("transition", "transform 0.2s ease, fill 0.2s ease") // Smooth transition

            // Glow effect and hover animation
            .on("mouseover", function (event, d) {
                const tooltip = d3.select("#map-card").append("div")
                    .attr("class", "tooltip bg-gray-800 text-white p-2 rounded")
                    .style("position", "absolute")
                    .style("left", `${0}px`)
                    .style("bottom", `${0}px`)
                    .html(`<strong>${d.nom}</strong><br>${d.description}`);

                // Highlight with a glowing effect
                d3.select(this)
                    .attr("fill", "yellow")
                    .style("filter", "drop-shadow(0 0 10px rgba(255, 255, 0, 0.8))"); // Yellow glow
            })
            .on("mouseout", function () {
                d3.select(".tooltip").remove();
                d3.select(this)
                    .attr("fill", "red")
                    .style("filter", "none");  // Remove glow on mouse out
            });

        mapGroup.selectAll(".player-dot").remove();
        // Create map markers for players
        mapGroup.selectAll(".player-dot")
            .data(players)
            .enter()
            .append("circle")
            .attr("cx", d => xScale(d.position.x))
            .attr("cy", d => yScale(d.position.y))
            .attr("r", 6) // Initial radius size
            .attr("fill", "blue")
            .attr("stroke", "white")  // Adding a white stroke to make it pop
            .attr("stroke-width", 1)
            .attr("class", "player-dot") // Assign a unique class
            .style("transition", "transform 0.2s ease, fill 0.2s ease") // Smooth transition

            // Glow effect and hover animation
            .on("mouseover", function (event, d) {
                const tooltip = d3.select("#map-card").append("div")
                    .attr("class", "tooltip bg-gray-800 text-white p-2 rounded")
                    .style("position", "absolute")
                    .style("left", `${0}px`)
                    .style("bottom", `${0}px`)
                    .html(`<strong>${d.nom}</strong><br>${d.description}`);

                // Highlight with a glowing effect
                d3.select(this)
                    .attr("fill", "cyan")
                    .style("filter", "drop-shadow(0 0 10px rgba(0, 255, 255, 0.8))"); // Cyan glow
            })
            .on("mouseout", function () {
                d3.select(".tooltip").remove();
                d3.select(this)
                    .attr("fill", "blue")
                    .style("filter", "none");  // Remove glow on mouse out
            });

        mapGroup.selectAll(".pnj-dot").remove();
        // Create map markers for players
        mapGroup.selectAll(".pnj-dot")
            .data(pnjs)
            .enter()
            .append("circle")
            .attr("cx", d => xScale(d.position.x))
            .attr("cy", d => yScale(d.position.y))
            .attr("r", 6) // Initial radius size
            .attr("fill", "silver")
            .attr("stroke", "white")  // Adding a white stroke to make it pop
            .attr("stroke-width", 1)
            .attr("class", "player-dot") // Assign a unique class
            .style("transition", "transform 0.2s ease, fill 0.2s ease") // Smooth transition

            // Glow effect and hover animation
            .on("mouseover", function (event, d) {
                const tooltip = d3.select("#map-card").append("div")
                    .attr("class", "tooltip bg-gray-800 text-white p-2 rounded")
                    .style("position", "absolute")
                    .style("left", `${0}px`)
                    .style("bottom", `${0}px`)
                    .html(`<strong>${d.nom}</strong><br>${d.description}`);

                // Highlight with a glowing effect
                d3.select(this)
                    .attr("fill", "cyan")
                    .style("filter", "drop-shadow(0 0 10px rgba(0, 255, 255, 0.8))"); // Cyan glow
            })
            .on("mouseout", function () {
                d3.select(".tooltip").remove();
                d3.select(this)
                    .attr("fill", "silver")
                    .style("filter", "none");  // Remove glow on mouse out
            });
}

    const updateChatLogs = () => {
        const chatWindow = document.getElementById('chat-window');
        chatWindow.innerHTML = '';

        logs.forEach(log => {

            // Create the message container
            const messageContainer = document.createElement('div');

            messageContainer.className = messageContainerClass[log.user]
                ? messageContainerClass[log.user]
                : messageContainerClass['DEFAULT'];

            // Determine message styling based on user type
            const isSystem = log.user === "SYSTEM";

            // Create player label if applicable
            const playerLabel = `<p class="font-bold text-sm ${messageTitleClass[log.user] ? messageTitleClass[log.user] : messageTitleClass["DEFAULT"]}">${log.user === "MASTER" ? "GAME MASTER" : log.user}</p>`

            // Build the message content
            // Set the innerHTML of the message container
            messageContainer.innerHTML = `
                <div class="${messageCardClass[log.user] ? messageCardClass[log.user] : messageCardClass["DEFAULT"]}">
                    ${playerLabel}
                    <p>${log.message}</p>
                </div>
            `;

            // Append the message container to the chat window
            chatWindow.appendChild(messageContainer);

            // Scroll to the latest message
            chatWindow.scrollTop = chatWindow.scrollHeight;
        });
    }
</script>

<script>
    /**
     * Pass data from Flask to JavaScript
     * Initialize DOM elements variables for further use
     */

    // Data passed from Flask
    let commands = {{commands | tojson}};
    let players = {{ players | tojson}};
    let locations = {{ locations | tojson}};
    let pnjs = {{ pnjs | tojson }};
    let locationsWithMonster = locations.filter(location => location.monstres);
    let logs = {{ logs | tojson}};
    let state = {{ state | tojson }};

    // Select the dropdown elements
    const commandDropdown = document.getElementById('command-dropdown');
    const playerDropdown = document.getElementById('player-dropdown');
    const locationsDropdown = document.getElementById('location-dropdown');
    const coordinateFields = document.getElementById('coordinate-fields');
    const userInput = document.getElementById('user-input');
    const coordXInput = document.getElementById('coord-x');
    const coordYInput = document.getElementById('coord-y');
    const timeInput = document.getElementById('time-input');

    // Chat form DOM elements
    const form = document.getElementById('chat-form');

    // App chat containers
    const chatForm = document.getElementById('chat-form');
    const chatWindow = document.getElementById('chat-window');

    // Dictionary to map user types to CSS classes
    const messageContainerClass = {
        DEFAULT: 'justify-end flex',
        MASTER: 'justify-start flex',
        FIGHT_DESCRIPTION: 'justify-center flex',
        SYSTEM: 'justify-center flex',
    };

    const messageCardClass = {
        DEFAULT: 'message bg-gray-200 text-gray-800 p-4 rounded-lg shadow-lg',
        MASTER: 'message bg-gray-200 text-gray-800 p-4 rounded-lg shadow-lg',
        FIGHT_DESCRIPTION: 'bg-gray-100 text-gray-700 p-5 rounded-lg shadow-md border border-gray-300 max-w-4xl font-bold',
        SYSTEM: 'message bg-transparent text-gray-800 italic text-xl',
    }

    const messageTitleClass = {
        DEFAULT: 'font-bold text-sm text-gray-700 mb-2',
        MASTER: 'font-bold text-sm text-red-700 mb-2',
        SYSTEM: 'hidden',
        FIGHT_DESCRIPTION: 'hidden',
    }

    updateDisplay()
</script>

<script>

    /*
    * Add an event listener to the form to handle form submission and command execution
    * Ensure the DOM is fully loaded before binding events
    */
    document.addEventListener('DOMContentLoaded', () => {
        // Event Listener for Command Dropdown
        commandDropdown.addEventListener('change', () => {
            console.log('Command Dropdown changed');
            // Get the selected index
            const selectedCommandName = commandDropdown.value;

            // Retrieve the selected command object
            const selectedCommand = commands.find(cmd => cmd.command === selectedCommandName);


            if (selectedCommand.playable) {
                // Populate the player dropdown with players
                playerDropdown.innerHTML = ''; // Clear existing options
                players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = player.id;
                    playerDropdown.appendChild(option);
                });

                // Show the player dropdown
                playerDropdown.classList.remove('hidden');
            } else {
                // Hide the player dropdown
                playerDropdown.classList.add('hidden');
            }

            if (selectedCommand.select_location_with_monsters) {
                // Populate the player dropdown with players
                locationsDropdown.innerHTML = ''; // Clear existing options
                locationsWithMonster.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = location.id;
                    locationsDropdown.appendChild(option);
                });

                // Show the player dropdown
                locationsDropdown.classList.remove('hidden');
            } else {
                // Hide the player dropdown
                locationsDropdown.classList.add('hidden');
            }

            // Handle coordinate fields visibility
            if (selectedCommand.coordinates) {
                coordinateFields.classList.remove('hidden'); // Show coordinate fields
                coordXInput.setAttribute('required', 'true'); // Add required attribute to X input
                coordYInput.setAttribute('required', 'true'); // Add required attribute to Y input
                userInput.disabled = true; // Disable user input field
                userInput.placeholder = "This command uses coordinates instead.";
            } else {
                coordinateFields.classList.add('hidden'); // Hide coordinate fields
                coordXInput.removeAttribute('required'); // Remove required attribute from X input
                coordYInput.removeAttribute('required'); // Remove required attribute from Y input
                userInput.disabled = false; // Enable user input field
                userInput.placeholder = "Entrer votre instruction...";
            }

            if (selectedCommand.time_input) {
                timeInput.classList.remove('hidden');
            } else {
                timeInput.classList.add('hidden');
            }

            console.log(selectedCommand.no_input)
            // Handle allowed user input
            if (selectedCommand.no_input) {
                userInput.value = ''; // Clear the input field
                userInput.disabled = true; // Disable the input field
                userInput.placeholder = "Cette commande ne nécessite pas d'entrée.";
                userInput.removeAttribute('required')
                userInput.classList.add("hidden");
            } else {
                userInput.disabled = false; // Enable the input field
                userInput.placeholder = "Entrer votre instruction...";
                userInput.classList.remove("hidden");
                userInput.setAttribute('required', 'true');
            }

        });
    });
</script>



<script>
    /**
     * Handle form submission and command execution
     */
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // Prevent default form submission

        // Gather form data
        const formData = new FormData(chatForm);
        console.log('Form Data:', formData);
        const actionUrl = chatForm.dataset.action;

        document.getElementById('loader').classList.remove('hidden');


        try {
            // Send POST request to the backend
            const response = await fetch(actionUrl, {
                method: 'POST',
                body: formData,
            });



            const result = await response.json();
            console.log('Server Response:', result);

            // Process each message in the response
            result.forEach(response => {
                updateChatLogs();
            });

            // Scroll to the bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // Clear the form input
            userInput.value = '';

            // fetch game information
            await fetchGameData();

            document.getElementById('loader').classList.add('hidden');

        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loader').classList.add('hidden');
        }
    });
</script>

<script>
    /**
     * Interactive map script
     */

    // Select the map card element
    const mapCard = document.getElementById('map-card');

    // Variable to keep track of whether the card has been clicked
    let isClicked = false;

    // Hover effect using Tailwind classes (increased length on hover)
    mapCard.addEventListener('mouseenter', function () {
        if (!isClicked) {
            mapCard.classList.add('hover:w-64', 'hover:h-48'); // Grow in width and height on hover
        }
    });

    mapCard.addEventListener('mouseleave', function () {
        if (!isClicked) {
            mapCard.classList.remove('hover:w-64', 'hover:h-48'); // Revert to normal size on hover out
        }
    });

    // Expand the card further on click
    mapCard.addEventListener('click', function (event) {
        event.stopPropagation(); // Prevent event from bubbling to document

        // Set the card to clicked state
        isClicked = true;

        // Expand the card even more on click
        mapCard.classList.add('w-10/12', 'h-5/6');
        mapCard.classList.remove('w-32', 'h-32');
        mapCard.classList.remove('hover:w-64', 'hover:h-48');

    });

    // Shrink the card back to default size when clicking outside
    document.addEventListener('click', function () {
        if (isClicked) {
            // Reset to original size
            mapCard.classList.remove('w-10/12', 'h-5/6');
            mapCard.classList.add('w-32', 'h-32');
            mapCard.classList.add('hover:w-64', 'hover:h-48');
            isClicked = false;
        }
    });

    // Prevent clicks inside the map card from triggering the document event
    mapCard.addEventListener('click', function (event) {
        event.stopPropagation();
    });
</script>

<script>
    /**
     * Overlay functionality
     */

    const playersItemEventListener = () => {
        const playerItems = document.querySelectorAll('.joueurs-list a');

        playerItems.forEach(item => {
            item.addEventListener('click', (event) => {
                event.preventDefault(); // Prevent default link behavior

                // remove existing overlay and info
                const existingOverlay = document.getElementById('overlay');
                const existingInfo = document.getElementById('info');
                if (existingOverlay) {
                    existingOverlay.remove();
                }
                if (existingInfo) {
                    existingInfo.remove();
                }

                // Get player ID
                const playerId = item.textContent.trim();
                const current_player = players[item.dataset.index];
                console.log(current_player);

                // Darken the chat window
                const chatWindow = document.getElementById('chat');

                const overlay = document.createElement('div');
                overlay.id = "overlay";
                overlay.className = 'h-full w-full absolute bg-gray-900 bg-opacity-75 fixed top-0 left-0 z-10';

                chatWindow.append(overlay);

                // Create the overlay
                const info = document.createElement('div');
                info.id = 'info';

                info.className = 'absolute inset-0 z-30 flex justify-center items-center';
                info.innerHTML = `
                <div class="bg-gradient-to-br from-gray-800 to-black text-white p-10 rounded-lg shadow-2xl relative h-5/6 w-full mx-16 " id="player-card">
                    <!-- Close Button -->
                    <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-200 text-3xl" id="close-overlay">
                        ✕
                    </button>

                    <div class="py-8 h-full overflow-y-auto">
                    <!-- Player Info Header -->
                    <h2 class="text-4xl font-extrabold mb-6 text-center text-indigo-400">${current_player.nom}</h2>
                    <p class="text-gray-300 mb-8">${current_player.description}</p>

                    <!-- 2x2 Grid Layout for Sections -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Attributes Section -->
                        <div class="p-6 rounded-lg bg-gray-800">
                            <h3 class="text-xl font-semibold text-yellow-500 mb-3">Attributs</h3>
                            <ul class="space-y-2">
                                <li><span class="font-medium text-gray-400">Charisme:</span> ${current_player.charisme}</li>
                                <li><span class="font-medium text-gray-400">Constitution:</span> ${current_player.constitution}</li>
                                <li><span class="font-medium text-gray-400">Dextérité:</span> ${current_player.dextérité}</li>
                                <li><span class="font-medium text-gray-400">Force:</span> ${current_player.force}</li>
                                <li><span class="font-medium text-gray-400">Intelligence:</span> ${current_player.intelligence}</li>
                                <li><span class="font-medium text-gray-400">Sagesse:</span> ${current_player.sagesse}</li>
                            </ul>
                        </div>

                        <!-- State Section -->
                        <div class="p-6 rounded-lg bg-gray-800">
                            <h3 class="text-xl font-semibold text-teal-400 mb-3">État</h3>
                            <ul class="space-y-2">
                                ${Object.entries(current_player.etat).map(([key, value]) => `
                                    <li><span class="font-medium text-gray-400">${key.charAt(0).toUpperCase() + key.slice(1)}:</span> ${value}</li>
                                `).join('')}
                            </ul>
                        </div>

                        <!-- Inventory Section -->
                        <div class="p-6 rounded-lg bg-gray-800">
                            <h3 class="text-xl font-semibold text-pink-500 mb-3">Inventaire</h3>
                            <ul class="space-y-2 list-disc pl-6">
                                ${current_player.inventaire.map(item => `
                                    <li class="text-gray-300">${item}</li>
                                `).join('')}
                            </ul>
                        </div>

                        <!-- Details Section -->
                        <div class="p-6 rounded-lg bg-gray-800">
                            <h3 class="text-xl font-semibold text-orange-400 mb-3">Details</h3>
                            <p><span class="font-medium text-gray-400">Or:</span> ${current_player.or}</p>
                            <p><span class="font-medium text-gray-400">Point de vie (PV):</span> ${current_player.pv}</p>
                            <p><span class="font-medium text-gray-400">Position:</span> (${current_player.position.x}, ${current_player.position.y})</p>
                        </div>
                    </div>
                </div>
                `;

                // Append the overlay to the chat window
                chatWindow.appendChild(info);

                // Close functionality for the close button
                document.getElementById('close-overlay').addEventListener('click', () => {
                    closeOverlay(info, overlay);
                });
            });
        })
    }

    const locationItemEventListener = () => {
        const locationItems = document.querySelectorAll('.locations-list a');

        locationItems.forEach(item => {
            item.addEventListener('click', (event) => {
                event.preventDefault(); // Prevent default link behavior

                // Remove existing overlay and info
                    const existingOverlay = document.getElementById('overlay');
                    const existingInfo = document.getElementById('info');
                    if (existingOverlay) {
                        existingOverlay.remove();
                    }
                    if (existingInfo) {
                        existingInfo.remove();
                    }

                    // Get location ID (or name here for simplicity)
                    const locationId = item.textContent.trim();
                    const current_location = locations[item.dataset.index];  // Assuming 'locations' data is available
                    console.log(current_location);

                    // Darken the chat window
                    const chatWindow = document.getElementById('chat');

                    const overlay = document.createElement('div');
                    overlay.id = "overlay";
                    overlay.className = 'h-full w-full absolute bg-gray-900 bg-opacity-75 fixed top-0 left-0 z-10';

                    // Create the overlay
                    const info = document.createElement('div');
                    info.id = 'info';

                    info.className = 'absolute inset-0 z-30 flex justify-center items-center';
                    info.innerHTML = `
              <div class="inset-0 bg-gradient-to-br from-gray-800 to-black text-white p-10 rounded-lg shadow-2xl relative h-5/6 w-full mx-16" id="location-card">
                <!-- Close Button -->
                <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-200 text-3xl" id="close-overlay">
                  ✕
                </button>

                <div class="py-8 h-full overflow-y-auto">
                  <!-- Location Info Header -->
                  <h2 class="text-4xl font-extrabold mb-6 text-center text-indigo-400">${current_location.nom}</h2>
                  <p class="text-gray-300 mb-8">${current_location.description}</p>

                  <!-- 2x2 Grid Layout for Sections -->
                  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Coordinates Section -->
                    <div class="p-6 rounded-lg bg-gray-800">
                      <h3 class="text-xl font-semibold text-yellow-500 mb-3">Coordonnées</h3>
                      <p class="text-gray-400">X: ${current_location.position.x}</p>
                      <p class="text-gray-400">Y: ${current_location.position.y}</p>
                    </div>

                    <!-- Type Section (Optional) -->
                    ${
                        current_location.type
                            ? `
                    <div class="p-6 rounded-lg bg-gray-800">
                      <h3 class="text-xl font-semibold text-green-500 mb-3">Type</h3>
                      <p class="text-gray-400">${current_location.type}</p>
                    </div>
                    `
                            : ""
                    }

                    <!-- Objects Section (Optional) -->
                    ${
                        current_location.objets && current_location.objets.length > 0
                            ? `
                    <div class="p-6 rounded-lg bg-gray-800">
                      <h3 class="text-xl font-semibold text-blue-500 mb-3">Objets Disponibles</h3>
                      <ul class="list-disc pl-5 text-gray-400">
                        ${current_location.objets
                                .map(
                                    (objet) =>
                                        `<li><strong>${objet.nom}</strong>: ${objet.description ? objet.description : ''} (Prix: ${objet.prix})</li>`
                                )
                                .join("")}
                      </ul>
                    </div>
                    `
                            : ""
                    }

                    <!-- Monsters Section (Optional) -->
                    ${
                        current_location.monstres && current_location.monstres.length > 0
                            ? `
                                                            <div class="p-6 rounded-lg bg-gray-800">
                                                              <h3 class="text-xl font-semibold text-red-500 mb-3">Monstres</h3>
                                                              <ul class="list-disc pl-5 text-gray-400">
                                                                ${current_location.monstres
                                .map(
                                    (monstre) => `
                                                                  <li>
                                                                    <strong>${monstre.nom}</strong>: ${monstre.description}
                                                                    (Puissance: ${monstre.puissance}, État: ${monstre.etat}, Nombre: ${monstre.nombre})
                                                                    ${
                                        monstre.objets && monstre.objets.length > 0
                                            ? `
                                                                    <ul class="list-disc pl-5">
                                                                      ${monstre.objets
                                                .map(
                                                    (obj) =>
                                                        `<li>${obj.nom}: ${obj.description} (Prix: ${obj.prix})</li>`
                                                )
                                                .join("")}
                                                                    </ul>
                                                                    `
                                            : ""
                                    }
                                                                  </li>
                                                                `
                                )
                                .join("")}
                                                              </ul>
                                                            </div>
                                                            `
                            : ""
                    }
                                                          </div>
                                                        </div>
                                                      </div>
                                                    `;
                    ;

                    chatWindow.append(overlay);
                    // Append the overlay to the chat window
                    chatWindow.appendChild(info);

                    // Close functionality for the close button
                    document.getElementById('close-overlay').addEventListener('click', () => {
                        closeOverlay(info, overlay);
                    });

                    overlay.addEventListener('click', () => {
                        console.log(
                            "Overlay clicked. Closing overlay..."
                        )
                        closeOverlay(info, overlay);
                    });
                });
            })
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        playersItemEventListener();
        locationItemEventListener();
    });
</script>

<script>
    /**
     * D3.js script to render the interactive map
     */

    // Get the SVG element
    const svg = d3.select("#map-svg");

    // Dynamically calculate the SVG height and width
    let width = svg.node().getBoundingClientRect().width;
    let height = svg.node().getBoundingClientRect().height;

    // Calculate min and max coordinates for scaling
    const allPositions = [
        ...locations.map(d => d.position),
        ...players.map(d => d.position)
    ];

    // Calculate min and max coordinates for scaling
    const xValues = allPositions.map(p => p.x);
    const yValues = allPositions.map(p => p.y);

    const xMin = Math.min(...xValues);
    const xMax = Math.max(...xValues);
    const yMin = Math.min(...yValues);
    const yMax = Math.max(...yValues);

    // Add padding to the domain for zoomed-in effect
    const padding = 10; // Adjust this value for more or less padding
    const xPadding = (xMax - xMin) * padding / 100; // Padding as a percentage of range
    const yPadding = (yMax - yMin) * padding / 100;

    // Create initial scales with dynamic padded domain
    let xScale = d3.scaleLinear()
        .domain([xMin - xPadding, xMax + xPadding])
        .range([20, width - 20]); // Add padding to the edges of the SVG

    let yScale = d3.scaleLinear()
        .domain([yMin - yPadding, yMax + yPadding])
        .range([20, height - 20]); // Use dynamic height for padding

    // Function to recalculate scales and update positions
    function updateScales() {
        width = svg.node().getBoundingClientRect().width;
        height = svg.node().getBoundingClientRect().height;

        // Recalculate the scales
        xScale = d3.scaleLinear()
            .domain([xMin - xPadding, xMax + xPadding])
            .range([20, width - 20]);

        yScale = d3.scaleLinear()
            .domain([yMin - yPadding, yMax + yPadding])
            .range([20, height - 20]);

        // Update the positions of the circles based on the new scales
        svg.selectAll("circle.location-dot")
            .attr("cx", d => xScale(d.position.x))
            .attr("cy", d => yScale(d.position.y));

        svg.selectAll("circle.green-location-dot")
            .attr("cx", d => xScale(d.position.x))
            .attr("cy", d => yScale(d.position.y));

        // Optionally, update the zoom behavior
        svg.selectAll("g").attr("transform", d3.zoomIdentity); // Reset zoom transform to default
    }

    // Apply zoom behavior
    const zoom = d3.zoom()
        .scaleExtent([0.5, 10]) // Set the zoom scale range (min and max zoom)
        .on("zoom", function (event) {
            const transform = event.transform;

            // Apply zoom transformation to the entire group
            svg.selectAll("g").attr("transform", transform);

            // Adjust the radius dynamically based on zoom level
            const zoomScale = transform.k;

            // Adjust circle radius dynamically with a more responsive scaling factor
            svg.selectAll(".location-dot")
                .attr("r", d => 6 * zoomScale);

            svg.selectAll(".green-location-dot")
                .attr("r", 6 * zoomScale);
        });

    // Set up the map's base group element
    const mapGroup = svg.append("g");

    // Styling for background to make it look more immersive (dark theme)
    svg.style("background-color", "#1e1e1e");  // Dark background
    svg.style("border", "2px solid #444444");  // Subtle border for the map
    svg.style("border-radius", "12px");  // Rounded corners for a sleek look

    updateMap();


    // Apply the zoom behavior to the SVG element
    svg.call(zoom);

    // Observe changes to the SVG size using ResizeObserver
    const resizeObserver = new ResizeObserver(() => {
        updateScales(); // Update the scales and positions when the SVG size changes
    });

    // Start observing the SVG element
    resizeObserver.observe(svg.node());
</script>


</body>
</html>




